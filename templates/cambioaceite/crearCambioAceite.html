{% extends 'index.html' %}
{% load static %}

{% block extracss %}
<!---Custom CSS-->
<link rel="stylesheet" href="{% static 'css/index.css' %}">
{% endblock %}

{% block titulo1 %}
<h2><strong>REGISTRO DE CAMBIO DE ACEITE</strong></h2>
{% endblock %}

{% block cuerpo %}
<form id="form_creacion" action="{% url 'asignacion-registrar-cambioaceite' %}" method="post">
    {% csrf_token %}
    <div class="form-row">
        <div class="form-group col-md-4 col-sm-4 col-xs-12">
            <label for="id_vehiculo_id">VEHÍCULO:</label>
            {{ form.vehiculo_id }}
        </div>
        <div class="form-group col-md-4 col-sm-4 col-xs-12">
            <label for="id_chofer_id">CHOFER:</label>
            {{ form.chofer_id }}
        </div>
        <div class="form-group col-md-4 col-sm-4 col-xs-12">
            <label for="id_mecanico_id">MECÁNICO:</label>
            {{ form.mecanico_id }}
        </div>
    </div>
    <div class="form-row">
        <div class="form-group col-md-4 col-sm-4 col-xs-12">
            <label for="id_km_actual">KM ACTUAL:</label>
            {{ form.km_actual }}
        </div>
        <div class="form-group col-md-4 col-sm-4 col-xs-12">
            <label for="id_proximo_cambio">PRÓXIMO CAMBIO:</label>
            {{ form.proximo_cambio }}
        </div>
        <div class="form-group col-md-4 col-sm-4 col-xs-12">
            <label for="id_maestranza">MAESTRANZA:</label> <!--por defecto maestranza en el modelo-->
            {{ form.maestranza }}
        </div>
    </div>
    <div class="form-row">
        <div class="form-group col-md-2 col-sm-3 col-xs-12">
            <label for="id_cambio_filtros">CAMBIO FILTROS:</label>
            {{ form.cambio_filtros }}
        </div>
        <div class="form-group col-md-3 col-sm-2 col-xs-12">
            <label for="id_aceite">ACEITE:</label>
            {{ form.aceite }}
        </div>
        <div class="form-group col-md-3 col-sm-2 col-xs-12">
            <label for="id_caja">CAJA:</label>
            {{ form.caja }}
        </div>
        <div class="form-group col-md-2 col-sm-2 col-xs-12">
            <label for="id_corona">CORONA:</label>
            {{ form.corona }}
        </div>
        <div class="form-group col-md-2 col-sm-3 col-xs-12">
            <label for="id_engrase">ENGRASE:</label>
            {{ form.engrase }}
        </div>
    </div>
    <div class="form-row">
        <div class="form-group col-md-2 col-sm-2 col-xs-12">
            <label for="id_fecha_hora_entrada">FECHA ENTRADA:</label>
            {{ form.fecha_hora_entrada }}
        </div>
        <div class="form-group col-md-2 col-sm-2 col-xs-12">
            <label for="id_hora_salida">HORA SALIDA:</label>
            {{ form.hora_salida }}
        </div>
        <div class="form-group col-md-6 col-sm-5 col-xs-12">
            <label for="id_unidad_id">UNIDAD:</label>
            {{ form.unidad_id }}
        </div>
        <div class="form-group col-md-2 col-sm-3 col-xs-12">
            <label for="id_aprobado">ORDEN APROBADA:</label>
            {{ form.aprobado }}
        </div>
    </div>
    <div id="error-message"></div>
    <div class="col-md-12 col-sm-12 col-xs-12 form-group">
        <button id="boton_creacion" class="btn btn-primary" type="button" onclick="registrar();">Confirmar</button>
        <a href="/asignacion/listar/cambioaceite" class="btn btn-danger" role="button">Cancelar</a>
    </div>
</form>
{% endblock %}
{% block extrajs %}
    <!---Custom JS-->
    <script src="{% static 'js/cambioaceite/cambioaceite.js' %}"></script>
    <script>
        $(document).ready(function () 
        {
            var currentDate = new Date();
            var year = currentDate.getFullYear();
            var month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
            var day = currentDate.getDate().toString().padStart(2, '0');
            var formattedDate = `${year}-${month}-${day}`;
            $("#id_fecha_hora_entrada").val(formattedDate);

            // Obtener referencia al elemento de entrada
            var $inputHoraActual = $('#id_hora_salida');

            // Función para obtener la hora actual y asignarla al campo de entrada
            function obtenerHoraActual() {
                // Crear un objeto de fecha y hora
                var fechaHora = new Date();

                // Obtener las partes de la hora
                var horas = fechaHora.getHours();
                var minutos = fechaHora.getMinutes();
                var segundos = fechaHora.getSeconds();

                // Formatear las partes de la hora para tener dos dígitos
                if (horas < 10) {
                horas = '0' + horas;
                }
                if (minutos < 10) {
                minutos = '0' + minutos;
                }
                if (segundos < 10) {
                segundos = '0' + segundos;
                }

                // Crear una cadena con el formato hh:mm:ss
                var horaActual = horas + ':' + minutos;

                // Asignar la hora actual al campo de entrada utilizando val()
                $inputHoraActual.val(horaActual);
            }

            // Llamar a la función inicialmente para mostrar la hora actual
            obtenerHoraActual();

            // Actualizar la hora cada segundo
            setInterval(obtenerHoraActual, 1000);
        });
    </script>
    <script>
        $(document).ready(function() {
            let parteSeleccionada;
            $('#id_vehiculo_id').on('input', function() {
                var vehiculoId = $('#id_vehiculo_id').val();
                let texto = $(this).find('option:selected').text();
                let partes = texto.split('-');
                //Sino funciona utilizar un for 
                parteSeleccionada = partes[2];

                $.ajax({
                    url: '/asignacion/obtener_ultimo_proximo_cambio/',
                    type: 'GET',
                    data: {
                        'vehiculo_id': vehiculoId,
                    },
                    success: function(response) {
                        $('#id_km_actual').val(response.proximo_cambio);
                        if (parteSeleccionada !== NaN){
                            if (parteSeleccionada === "MOTOCICLETA"){
                                $('#id_proximo_cambio').val(1000);
                                let kmActual = parseInt($('#id_km_actual').val());
                                let proximocambio = parseInt($('#id_proximo_cambio').val());
                                let suma = kmActual + proximocambio;
                                $('#id_proximo_cambio').val(suma);
                            }
                            else{
                                $('#id_proximo_cambio').val(5000);
                                let kmActual = parseInt($('#id_km_actual').val());
                                let proximocambio = parseInt($('#id_proximo_cambio').val());
                                let suma = kmActual + proximocambio;
                                $('#id_proximo_cambio').val(suma);
                            }
                        }
                    },
                    error: function(xhr, errmsg, err) {
                        mostrarError('No existe ningún registro de cambio de aceite del vehículo.');
                        if (parteSeleccionada !== NaN){
                            if (parteSeleccionada === "MOTOCICLETA"){
                                $('#id_km_actual').val(0);
                                $('#id_proximo_cambio').val(1000);
                            }
                            else{
                                $('#id_km_actual').val(0);
                                $('#id_proximo_cambio').val(5000);
                            }
                        }
                    }
                });
            });

            function mostrarError(mensaje) {
                $('#error-message').text(mensaje);
                $('#error-message').fadeIn();
                setTimeout(function() {
                    $('#error-message').fadeOut();
                }, 3000); // Tiempo en milisegundos para que el mensaje de error se muestre antes de desaparecer
            }

            $('#id_km_actual').on('input', function() {
                if (parteSeleccionada !== NaN){
                    if (parteSeleccionada === "MOTOCICLETA"){
                        if ($(this).val() !== '') {
                            let valor1 = $(this).val();
                            // Aumentar el valor en 1000
                            let valor2 = parseInt(valor1) + 1000;
                            // Asignar el valor aumentado al segundo input
                            $('#id_proximo_cambio').val(valor2);
                        }
                    }
                    else{
                        if ($(this).val() !== '') {
                            let valor1 = $(this).val();
                            // Aumentar el valor en 5000
                            let valor2 = parseInt(valor1) + 5000;
                            // Asignar el valor aumentado al segundo input
                            $('#id_proximo_cambio').val(valor2);
                        }
                    }
                }
            });
        });
    </script>
    <script>
        $(document).ready(function() {
            $('#id_vehiculo_id').on('input', function() {
                let vehiculoId = $(this).val();
                $.ajax({
                    url: '/asignacion/obtener-chofer-unidad/' + vehiculoId + '/',
                    type: 'GET',
                    success: function(data) {
                        let chofer = data.chofer.nombres;
                        let nombreUnidad = data.unidad.nombre_unidad;
                        // Buscar y seleccionar la opción de unidad correspondiente
                        $('#id_chofer_id option').each(function() {
                            if ($(this).text().trim() === chofer.trim()) {
                                $(this).prop('selected', true);
                                return false; // Salir del bucle each() una vez encontrada la opción
                            }
                        });
                        $('#id_unidad_id option').each(function() {
                            if ($(this).text().trim() === nombreUnidad.trim()) {
                                $(this).prop('selected', true);
                                return false;
                            }
                        });
                    },
                    error: function() {
                        $('#id_chofer_id').val('');
                        $('#id_unidad_id').val('');
                    }
                });
            });
        });
    </script>
{% endblock %}
